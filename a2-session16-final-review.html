<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2 Session 16: Final Assessment</title>
    <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#2E7D32;min-height:100vh;padding:20px}
.container{max-width:800px;margin:0 auto}
.header{background:#fff;border-radius:20px;padding:30px;margin-bottom:20px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.header h1{color:#2E7D32;font-size:1.4em}
.header p{color:#888}
.badge{background:#ef4444;color:#fff;padding:4px 12px;border-radius:20px;font-size:.8em}
.level-badge{background:#2E7D32;color:#fff;padding:6px 16px;border-radius:20px;font-size:.9em;display:inline-block;margin-bottom:10px}
.card{background:#fff;border-radius:16px;padding:25px;margin-bottom:20px}
.card h2{color:#2E7D32;margin-bottom:15px}
label{font-weight:600;color:#333;display:block;margin-bottom:8px}
input[type="text"],select{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;margin-bottom:15px}
input:focus,select:focus{outline:none;border-color:#2E7D32}
.btn{background:#2E7D32;color:#fff;border:none;padding:14px 32px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;width:100%;margin-top:10px;transition:all .2s}
.btn:hover{background:#1B5E20}
.btn:disabled{opacity:.5}
.btn-orange{background:#F5A623}
.btn-secondary{background:#f5f5f5;color:#333}
.section{display:none}
.section.active{display:block}
.reading-box{background:#f8f9fa;border-radius:12px;padding:20px;margin-bottom:20px;border-left:4px solid #2E7D32;line-height:1.8}
.question{background:#f8f9fa;border-radius:12px;padding:20px;margin:15px 0;border:1px solid #eee}
.question h4{margin-bottom:15px;color:#333}
.option{padding:14px;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;gap:12px}
.option:hover{border-color:#2E7D32;background:#f1f8e9}
.option.selected{border-color:#2E7D32;background:#e8f5e9}
.option.correct{border-color:#22c55e;background:#f0fdf4}
.option.incorrect{border-color:#ef4444;background:#fef2f2}
.circle{width:20px;height:20px;border:2px solid #ccc;border-radius:50%;flex-shrink:0}
.option.selected .circle{border-color:#2E7D32;background:#2E7D32}
textarea{width:100%;min-height:120px;padding:14px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;font-family:inherit;resize:vertical}
textarea:focus{outline:none;border-color:#2E7D32}
.progress{height:8px;background:#e0e0e0;border-radius:4px;margin-bottom:20px}
.progress-bar{height:100%;background:#F5A623;border-radius:4px;transition:width .3s}
.progress-text{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;color:#666}
.score-card{background:linear-gradient(135deg,#2E7D32,#43A047);border-radius:20px;padding:35px;color:#fff;text-align:center}
.score-big{font-size:4em;font-weight:700}
.scores{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:20px}
.scores>div{background:rgba(255,255,255,.15);border-radius:12px;padding:12px}
.scores label{font-size:.75em;opacity:.9}
.scores span{font-size:1.4em;font-weight:700;display:block}
.record-btn{width:80px;height:80px;border-radius:50%;background:#fff;border:3px solid #2E7D32;cursor:pointer;margin:20px auto;display:flex;align-items:center;justify-content:center}
.record-btn:hover{background:#f1f8e9}
.record-btn.recording{border-color:#ef4444;animation:pulse 1.5s infinite}
.record-dot{width:24px;height:24px;background:#2E7D32;border-radius:50%}
.record-btn.recording .record-dot{background:#ef4444;border-radius:4px;width:20px;height:20px}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 15px rgba(239,68,68,0)}}
.timer{text-align:center;font-size:28px;font-weight:700;color:#2E7D32}
.status{text-align:center;color:#666;margin-top:10px}
audio{width:100%;margin-top:15px}
.hidden{display:none}
.feedback{background:#f1f8e9;border:1px solid #2E7D32;border-radius:12px;padding:20px;margin-top:15px}
.feedback h4{color:#2E7D32;margin-bottom:10px}
.nav-buttons{display:flex;justify-content:space-between;margin-top:20px}
.cefr-box{background:linear-gradient(135deg,#1565C0,#1976D2);color:#fff;border-radius:12px;padding:20px;margin-top:20px;text-align:center}
.cefr-box h3{margin-bottom:10px}
.cefr-level{font-size:2em;font-weight:700}
.transcript-box{background:#e8f5e9;border:1px solid #a5d6a7;border-radius:8px;padding:15px;margin-top:15px;font-style:italic;color:#2e7d32}
.transcript-box.visible{display:block}
.not-submitted{background:#ffebee;border:2px solid #ef5350;border-radius:12px;padding:20px;text-align:center;animation:pulse-warning 2s infinite}
.not-submitted h3{color:#c62828;margin-bottom:10px}
@keyframes pulse-warning{0%,100%{box-shadow:0 0 0 0 rgba(239,83,80,.4)}50%{box-shadow:0 0 0 10px rgba(239,83,80,0)}}
.submitted-success{background:#e8f5e9;border:2px solid #66bb6a;border-radius:12px;padding:20px;text-align:center;display:none}
.submitted-success h3{color:#2e7d32}
.prompt-box{background:#f1f8e9;border:1px solid #c8e6c9;border-radius:12px;padding:20px;margin-bottom:20px}
.prompt-box h4{color:#2E7D32;margin-bottom:10px}
.tips-list{margin-top:12px;padding-left:20px}
.tips-list li{color:#666;margin-bottom:6px}
.word-count{text-align:right;color:#888;font-size:14px;margin-top:8px}
@media(max-width:600px){.scores{grid-template-columns:repeat(3,1fr)}}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="level-badge">CEFR Level A2 - Elementary</div>
        <h1>üìö Session 16: Final Assessment <span class="badge">FINAL</span></h1>
        <p>Week 8 ‚Ä¢ Practical Skills II Complete Review</p>
    </div>

    <!-- Start Section -->
    <div class="section active" id="start">
        <div class="card">
            <h2>Welcome to Your Final Assessment!</h2>
            <p style="color:#666;margin-bottom:20px">This assessment covers everything you learned in A2:</p>
            <ul style="color:#666;margin-bottom:20px;padding-left:20px">
                <li>Present Simple & Present Continuous</li>
                <li>Modal Verbs (can, could, may, might, should)</li>
                <li>Past Simple (regular & irregular verbs)</li>
                <li>Vocabulary: Weather, Work, Family, Health, Housing, Travel</li>
            </ul>
            <label>Your Full Name</label>
            <input type="text" id="studentName" placeholder="Enter your name...">
            <label>Your Class</label>
            <select id="studentClass">
                <option value="">Select your class...</option>
                <option value="A2-MW-9AM">A2 - Mon/Wed 9:00 AM</option>
                <option value="A2-MW-11AM">A2 - Mon/Wed 11:00 AM</option>
                <option value="A2-MW-8PM">A2 - Mon/Wed 8:00 PM</option>
                <option value="A2-TTH-9AM">A2 - Tue/Thu 9:00 AM</option>
                <option value="A2-TTH-11AM">A2 - Tue/Thu 11:00 AM</option>
                <option value="A2-TTH-8PM">A2 - Tue/Thu 8:00 PM</option>
            </select>
            <button class="btn" onclick="startQuiz()">Start Final Assessment ‚Üí</button>
        </div>
    </div>

    <!-- Section 1: Reading -->
    <div class="section" id="s1">
        <div class="card">
            <div class="progress-text"><span>Section 1 of 5</span><span>20%</span></div>
            <div class="progress"><div class="progress-bar" style="width:20%"></div></div>
            <h2>üìñ 1. Reading Comprehension</h2>
            <div class="reading-box">
                <p><strong>Maria's New Life in America</strong></p>
                <p>Maria moved to the United States two years ago from Mexico. At first, everything was difficult. She didn't speak English well, and she had to learn new customs.</p>
                <p>Now, Maria works at a hospital as a nurse's assistant. She usually works from 7 AM to 3 PM, but sometimes she works the night shift. She likes her job because she can help people.</p>
                <p>Last month, Maria had a problem with her apartment. The heater was broken, and it was very cold. She called her landlord and said, "Could you please fix the heater?" The landlord came the next day and fixed it.</p>
                <p>Maria is going to visit her family in Mexico next summer. She is very excited because she hasn't seen them for a long time. "I should save more money for my trip," she says.</p>
            </div>
            <div id="readingQuestions"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goBack0()">‚Üê Back</button>
                <button class="btn" onclick="checkS1()">Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Section 2: Vocabulary -->
    <div class="section" id="s2">
        <div class="card">
            <div class="progress-text"><span>Section 2 of 5</span><span>40%</span></div>
            <div class="progress"><div class="progress-bar" style="width:40%"></div></div>
            <h2>üìù 2. Vocabulary Review</h2>
            <p style="color:#666;margin-bottom:15px">Fill in the blanks with the correct word:</p>
            <div id="vocabQuestions"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goTo('s1')">‚Üê Back</button>
                <button class="btn" onclick="checkS2()">Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Section 3: Writing -->
    <div class="section" id="s3">
        <div class="card">
            <div class="progress-text"><span>Section 3 of 5</span><span>60%</span></div>
            <div class="progress"><div class="progress-bar" style="width:60%"></div></div>
            <h2>‚úçÔ∏è 3. Writing</h2>
            <div class="prompt-box">
                <h4>Writing Task</h4>
                <p>Write about your daily routine and a past experience (6-8 sentences). Include:</p>
                <ul class="tips-list">
                    <li><strong>Present Simple:</strong> What do you usually do? (I wake up at..., I work at...)</li>
                    <li><strong>Present Continuous:</strong> What are you doing now? (I am studying...)</li>
                    <li><strong>Past Simple:</strong> What did you do last week? (I visited..., I went...)</li>
                    <li><strong>Modal verbs:</strong> Use should, can, could, or must</li>
                </ul>
            </div>
            <textarea id="writing" placeholder="Every day, I wake up at 6 AM. I usually take the bus to work...&#10;&#10;Last weekend, I visited my friend. We went to...&#10;&#10;Right now, I am studying English because I should improve my skills..." oninput="updateWC()"></textarea>
            <div class="word-count">Words: <span id="wc">0</span></div>
            <div class="feedback hidden" id="wFeedback"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goTo('s2')">‚Üê Back</button>
                <button class="btn" id="wBtn" onclick="checkWriting()">Get Feedback ‚Üí</button>
                <button class="btn hidden" id="wNext" onclick="goTo('s4')">Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Section 4: Speaking -->
    <div class="section" id="s4">
        <div class="card">
            <div class="progress-text"><span>Section 4 of 5</span><span>80%</span></div>
            <div class="progress"><div class="progress-bar" style="width:80%"></div></div>
            <h2>üé§ 4. Speaking</h2>
            <div class="prompt-box">
                <h4>Speaking Task (30-60 seconds)</h4>
                <p>Talk about ONE of these topics:</p>
                <ul class="tips-list">
                    <li><strong>Your job:</strong> What do you do? What are your responsibilities?</li>
                    <li><strong>Your last vacation:</strong> Where did you go? What did you do?</li>
                    <li><strong>Your home:</strong> Describe your apartment/house. What do you like about it?</li>
                </ul>
                <p style="margin-top:10px;font-style:italic">Try to use different tenses and vocabulary from the course!</p>
            </div>
            <button class="record-btn" id="recBtn" onclick="toggleRec()"><div class="record-dot"></div></button>
            <div class="timer" id="timer">0:00</div>
            <div class="status" id="recStatus">Click to start recording</div>
            <audio id="audio" controls class="hidden"></audio>
            <div id="transcriptBox" class="transcript-box hidden"></div>
            <div class="feedback hidden" id="sFeedback"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goTo('s3')">‚Üê Back</button>
                <button class="btn" id="sBtn" onclick="checkSpeaking()" disabled>Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Section 5: Grammar -->
    <div class="section" id="s5">
        <div class="card">
            <div class="progress-text"><span>Section 5 of 5</span><span>100%</span></div>
            <div class="progress"><div class="progress-bar" style="width:100%"></div></div>
            <h2>üìö 5. Grammar Quiz</h2>
            <div id="grammarQuestions"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goTo('s4')">‚Üê Back</button>
                <button class="btn btn-orange" onclick="submitFinal()">Submit Final Assessment ‚úì</button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="section" id="results">
        <div class="score-card">
            <p style="opacity:.8">üéâ Congratulations! A2 Course Complete! üéâ</p>
            <div class="score-big" id="finalPct">0%</div>
            <p id="studentDisplay"></p>
            <div class="scores">
                <div><label>Reading</label><span id="scL">0/3</span></div>
                <div><label>Vocab</label><span id="scV">0/6</span></div>
                <div><label>Writing</label><span id="scW">0/20</span></div>
                <div><label>Speaking</label><span id="scS">0/20</span></div>
                <div><label>Grammar</label><span id="scG">0/8</span></div>
            </div>
            <div class="cefr-box">
                <h3>Your CEFR Progress</h3>
                <div class="cefr-level" id="cefrLevel">A2</div>
                <p id="cefrMessage">You have completed the A2 Elementary level!</p>
            </div>
            <div style="margin-top:25px">
                <div class="not-submitted" id="notSubmittedWarning">
                    <h3>‚ö†Ô∏è NOT YET SUBMITTED</h3>
                    <p>Click the button below to submit your results to your teacher</p>
                </div>
                <div class="submitted-success" id="submittedSuccess">
                    <h3>‚úì Submitted Successfully!</h3>
                    <p>Your teacher will receive your results</p>
                </div>
                <button class="btn btn-orange" id="submitBtn" onclick="submitToTeacher()" style="margin-top:15px;font-size:20px;padding:20px">üì§ Submit to Teacher</button>
            </div>
        </div>
    </div>
</div>

<script>
const SESSION='A2 Session 16 (FINAL)';
let studentName='',studentClass='',scores={l:0,v:0,w:0,s:0,g:0},writingText='',speechTranscript='';
let isRec=false,mediaRec=null,chunks=[],recTime=0,recTimer=null;

// Reading Questions - Based on A2 Curriculum topics
const readingQBank=[
    {q:"When did Maria move to the United States?",opts:["Last year","Two years ago","Three years ago"],correct:1},
    {q:"What time does Maria usually start work?",opts:["6 AM","7 AM","8 AM"],correct:1},
    {q:"What was the problem with Maria's apartment?",opts:["The sink was leaking","The heater was broken","There was no internet"],correct:1},
    {q:"How did Maria ask her landlord for help?",opts:["She sent an email","She called and said 'Could you please fix it?'","She fixed it herself"],correct:1},
    {q:"What is Maria going to do next summer?",opts:["Start a new job","Visit her family in Mexico","Move to a new apartment"],correct:1}
];

// Grammar Questions - Covering all A2 topics
const grammarQBank=[
    {q:"She _____ to work every day.",opts:["go","goes","going"],correct:1},
    {q:"I am _____ English right now.",opts:["study","studies","studying"],correct:2},
    {q:"Yesterday, I _____ my grandmother.",opts:["visit","visited","visiting"],correct:1},
    {q:"_____ you help me, please?",opts:["Could","Do","Are"],correct:0},
    {q:"He _____ work at 9 AM.",opts:["start","starts","starting"],correct:1},
    {q:"They _____ to the beach last summer.",opts:["go","goes","went"],correct:2},
    {q:"You _____ take medicine if you feel sick.",opts:["should","are","do"],correct:0},
    {q:"She _____ cooking dinner at the moment.",opts:["is","does","was"],correct:0},
    {q:"I _____ have a headache. I need rest.",opts:["do","did","have"],correct:2},
    {q:"We _____ see a movie tomorrow.",opts:["going to","are going to","went"],correct:1}
];

// Vocabulary - A2 topics (weather, work, family, health, housing, travel)
const vocabBank=[
    {q:"Weather: It's very cold. The temperature is _____.",a:"freezing"},
    {q:"Work: My _____ told me to finish the report today.",a:"boss"},
    {q:"Family: My mother's sister is my _____.",a:"aunt"},
    {q:"Health: I have a bad _____. I should see a doctor.",a:"cough"},
    {q:"Housing: I pay _____ to my landlord every month.",a:"rent"},
    {q:"Travel: Last summer, I _____ to the beach.",a:"went"},
    {q:"Work: I work _____ (not full-time).",a:"part-time"},
    {q:"Health: The doctor gave me a _____ for medicine.",a:"prescription"}
];

let readingAnswers=[],grammarAnswers=[];

function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

function initQuestions(){
    // Reading questions
    const rQs=shuffle([...readingQBank]).slice(0,3);
    let rHTML='';
    rQs.forEach((q,i)=>{
        const shuffledOpts=q.opts.map((opt,idx)=>({text:opt,isCorrect:idx===q.correct}));
        shuffle(shuffledOpts);
        readingAnswers[i]=shuffledOpts.findIndex(o=>o.isCorrect);
        rHTML+=`<div class="question"><h4>${i+1}. ${q.q}</h4>`;
        shuffledOpts.forEach((opt,j)=>{
            rHTML+=`<div class="option" onclick="sel(this)" data-v="${j}"><div class="circle"></div>${opt.text}</div>`;
        });
        rHTML+=`</div>`;
    });
    document.getElementById('readingQuestions').innerHTML=rHTML;

    // Vocabulary questions
    const vQs=shuffle([...vocabBank]).slice(0,6);
    let vHTML='';
    vQs.forEach((v,i)=>{
        vHTML+=`<div class="question"><p>${i+1}. ${v.q}</p><input type="text" class="vocab-input" data-a="${v.a.toLowerCase()}" placeholder="Type your answer..." style="margin-top:10px"></div>`;
    });
    document.getElementById('vocabQuestions').innerHTML=vHTML;

    // Grammar questions
    const gQs=shuffle([...grammarQBank]).slice(0,8);
    let gHTML='';
    gQs.forEach((q,i)=>{
        const shuffledOpts=q.opts.map((opt,idx)=>({text:opt,isCorrect:idx===q.correct}));
        shuffle(shuffledOpts);
        grammarAnswers[i]=shuffledOpts.findIndex(o=>o.isCorrect);
        gHTML+=`<div class="question" data-c="${grammarAnswers[i]}"><h4>${i+1}. ${q.q}</h4>`;
        shuffledOpts.forEach((opt,j)=>{
            gHTML+=`<div class="option" onclick="sel(this)" data-v="${j}"><div class="circle"></div>${opt.text}</div>`;
        });
        gHTML+=`</div>`;
    });
    document.getElementById('grammarQuestions').innerHTML=gHTML;
}

function startQuiz(){
    studentName=document.getElementById('studentName').value.trim();
    studentClass=document.getElementById('studentClass').value;
    if(!studentName){alert('Please enter your name');return;}
    if(!studentClass){alert('Please select your class');return;}
    initQuestions();
    goTo('s1');
}

function goTo(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
}

function goBack0(){
    document.getElementById('s1').classList.remove('active');
    document.getElementById('start').classList.add('active');
}

function sel(el){
    el.parentElement.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
    el.classList.add('selected');
}

function checkS1(){
    let correct=0;
    document.querySelectorAll('#readingQuestions .question').forEach((q,i)=>{
        const selected=q.querySelector('.option.selected');
        if(selected&&parseInt(selected.dataset.v)===readingAnswers[i])correct++;
    });
    scores.l=correct;
    goTo('s2');
}

function checkS2(){
    let correct=0;
    document.querySelectorAll('.vocab-input').forEach(input=>{
        const val=input.value.trim().toLowerCase();
        const ans=input.dataset.a;
        if(val===ans){
            correct++;
            input.style.borderColor='#22c55e';
            input.style.background='#f0fdf4';
        }else{
            input.style.borderColor='#ef4444';
            input.style.background='#fef2f2';
        }
    });
    scores.v=correct;
    goTo('s3');
}

function updateWC(){
    document.getElementById('wc').textContent=document.getElementById('writing').value.trim().split(/\s+/).filter(w=>w).length;
}

function checkWriting(){
    writingText=document.getElementById('writing').value;
    const text=writingText.toLowerCase();
    const wc=text.trim().split(/\s+/).filter(w=>w).length;
    
    // Check for grammar patterns
    const psPatterns=['usually','always','every day','sometimes','never','often'];
    const pcPatterns=['am ','is ','are ','-ing','right now','at the moment'];
    const pastPatterns=['yesterday','last week','last month','last year','ago','visited','went','saw','did','was','were'];
    const modalPatterns=['should','could','can','must','may','might'];
    
    const foundPS=psPatterns.filter(p=>text.includes(p)).length;
    const foundPC=pcPatterns.filter(p=>text.includes(p)).length;
    const foundPast=pastPatterns.filter(p=>text.includes(p)).length;
    const foundModal=modalPatterns.filter(p=>text.includes(p)).length;
    
    let score=Math.min(5,foundPS*2)+Math.min(5,foundPC*2)+Math.min(5,foundPast*2)+Math.min(3,foundModal*2)+(wc>=50?2:0);
    scores.w=Math.min(20,score);
    
    document.getElementById('wFeedback').innerHTML=`
        <h4>Feedback</h4>
        <p>‚úì Present Simple markers: ${foundPS}</p>
        <p>‚úì Present Continuous markers: ${foundPC}</p>
        <p>‚úì Past Simple markers: ${foundPast}</p>
        <p>‚úì Modal verbs: ${foundModal}</p>
        <p>‚úì Word count: ${wc}</p>
        <p><strong>Score: ${scores.w}/20</strong></p>
    `;
    document.getElementById('wFeedback').classList.remove('hidden');
    document.getElementById('wBtn').classList.add('hidden');
    document.getElementById('wNext').classList.remove('hidden');
}

async function toggleRec(){
    if(!isRec){
        try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec=new MediaRecorder(stream);
            chunks=[];
            mediaRec.ondataavailable=e=>chunks.push(e.data);
            mediaRec.onstop=()=>{
                document.getElementById('audio').src=URL.createObjectURL(new Blob(chunks,{type:'audio/webm'}));
                document.getElementById('audio').classList.remove('hidden');
                document.getElementById('sBtn').disabled=false;
            };
            mediaRec.start();
            isRec=true;
            recTime=0;
            document.getElementById('recBtn').classList.add('recording');
            document.getElementById('recStatus').textContent='Recording... Click to stop';
            
            // Speech recognition
            const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
            if(SpeechRecognition){
                const recognition=new SpeechRecognition();
                recognition.continuous=true;
                recognition.interimResults=true;
                recognition.lang='en-US';
                recognition.onresult=(e)=>{
                    let transcript='';
                    for(let i=0;i<e.results.length;i++){
                        transcript+=e.results[i][0].transcript;
                    }
                    speechTranscript=transcript;
                    document.getElementById('transcriptBox').textContent='üìù '+transcript;
                    document.getElementById('transcriptBox').classList.remove('hidden');
                };
                recognition.onerror=(e)=>{console.log('Speech error:',e.error)};
                recognition.start();
                window.currentRecognition=recognition;
            }
            
            recTimer=setInterval(()=>{
                recTime++;
                document.getElementById('timer').textContent=Math.floor(recTime/60)+':'+(recTime%60).toString().padStart(2,'0');
            },1000);
        }catch(e){alert('Microphone error: '+e.message);}
    }else{
        mediaRec.stop();
        mediaRec.stream.getTracks().forEach(t=>t.stop());
        clearInterval(recTimer);
        isRec=false;
        if(window.currentRecognition)window.currentRecognition.stop();
        document.getElementById('recBtn').classList.remove('recording');
        document.getElementById('recStatus').textContent='Recording saved!';
    }
}

function checkSpeaking(){
    scores.s=recTime>=30?20:recTime>=20?15:recTime>=10?10:5;
    document.getElementById('sFeedback').innerHTML=`
        <h4>Feedback</h4>
        <p>Duration: ${Math.floor(recTime/60)}:${(recTime%60).toString().padStart(2,'0')}</p>
        <p><strong>Score: ${scores.s}/20</strong></p>
    `;
    document.getElementById('sFeedback').classList.remove('hidden');
    goTo('s5');
}

function submitFinal(){
    let correct=0;
    document.querySelectorAll('#grammarQuestions .question').forEach((q,i)=>{
        const sel=q.querySelector('.option.selected');
        const ans=parseInt(q.dataset.c);
        if(sel){
            if(parseInt(sel.dataset.v)===ans){
                correct++;
                sel.classList.add('correct');
            }else{
                sel.classList.add('incorrect');
                q.querySelector('[data-v="'+ans+'"]').classList.add('correct');
            }
        }
    });
    scores.g=correct;
    
    const total=scores.l+scores.v+scores.w+scores.s+scores.g;
    const pct=Math.round(total/57*100);
    
    document.getElementById('finalPct').textContent=pct+'%';
    document.getElementById('studentDisplay').textContent=studentName+' ['+studentClass+']';
    document.getElementById('scL').textContent=scores.l+'/3';
    document.getElementById('scV').textContent=scores.v+'/6';
    document.getElementById('scW').textContent=scores.w+'/20';
    document.getElementById('scS').textContent=scores.s+'/20';
    document.getElementById('scG').textContent=scores.g+'/8';
    
    // CEFR assessment
    let cefrLevel='A2';
    let cefrMsg='';
    if(pct>=85){
        cefrLevel='A2+ ‚Üí B1';
        cefrMsg='Excellent! You are ready to move to B1 Intermediate level!';
    }else if(pct>=70){
        cefrLevel='A2';
        cefrMsg='Great job! You have solid A2 Elementary skills.';
    }else if(pct>=50){
        cefrLevel='A2-';
        cefrMsg='Good progress! Keep practicing to strengthen your A2 skills.';
    }else{
        cefrLevel='A1+';
        cefrMsg='You may need more practice at the A2 level before moving on.';
    }
    document.getElementById('cefrLevel').textContent=cefrLevel;
    document.getElementById('cefrMessage').textContent=cefrMsg;
    
    goTo('results');
}

function submitToTeacher(){
    const pct=Math.round((scores.l+scores.v+scores.w+scores.s+scores.g)/57*100);
    const sn=studentName+' ['+studentClass+']';
    const transcript=speechTranscript||'[No transcript - Recording duration: '+Math.floor(recTime/60)+':'+(recTime%60).toString().padStart(2,'0')+']';
    
    const cefrResult=document.getElementById('cefrLevel').textContent;
    const url='https://docs.google.com/forms/d/e/1FAIpQLSd9ACrRqGcnC8C0XEHLHNyTGGOlBwf7oMrwW7YixAjCWSlLfg/viewform?usp=pp_url'+
        '&entry.518151516='+encodeURIComponent(sn)+
        '&entry.864654596='+encodeURIComponent(SESSION)+
        '&entry.258952242='+encodeURIComponent(scores.l+'/3')+
        '&entry.859150584='+encodeURIComponent(scores.v+'/6')+
        '&entry.939912807='+encodeURIComponent(writingText)+
        '&entry.1121796741='+encodeURIComponent(scores.w+'/20')+
        '&entry.2086302086='+encodeURIComponent(transcript)+
        '&entry.1435469716='+encodeURIComponent(scores.s+'/20')+
        '&entry.1998281944='+encodeURIComponent(scores.g+'/8')+
        '&entry.1207114914='+encodeURIComponent(pct+'%')+
        '&entry.73595410='+encodeURIComponent(cefrResult);
    
    document.getElementById('notSubmittedWarning').style.display='none';
    document.getElementById('submittedSuccess').style.display='block';
    document.getElementById('submitBtn').style.display='none';
    window.open(url,'_blank');
}
</script>
</body>
</html>
